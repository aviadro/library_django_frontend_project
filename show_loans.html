<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loan Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Library System</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ml-auto">
            <!-- Navbar items -->
            <li class="nav-item">
              <a class="nav-link" href="/login.html">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/register.html">Register</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/all_books.html">Our Book List</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/loaning_books.html">Loan Book</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/add_book.html">Add Book</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/show_loans.html">Show Loan List</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users_list.html">Show Users List</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <h1 class="text-center">Loan Management</h1>

      <div id="loan-container">
        <div class="mb-4">
          <h3>Active Loans</h3>
          <div id="active-loans" class="list-group"></div>
        </div>

        <div>
          <h3>Inactive Loans</h3>
          <div id="inactive-loans" class="list-group"></div>
        </div>
      </div>

      <!-- Not Authorized Message -->
      <div
        id="not-authorized"
        class="alert alert-danger text-center mt-5"
        style="display: none"
      >
        <p>Only Admin is authorized and has access to this page.</p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const response = await axios.get(
            'http://127.0.0.1:8000/loans/display_loans',
            {
              headers: {
                Authorization: 'Bearer ' + localStorage.getItem('token'), // Use token for admin authentication
              },
            }
          )

          if (response.status === 200) {
            const { active_loans, inactive_loans } = response.data

            const activeLoansContainer = document.getElementById('active-loans')
            const inactiveLoansContainer =
              document.getElementById('inactive-loans')

            // Clear existing content
            activeLoansContainer.innerHTML = ''
            inactiveLoansContainer.innerHTML = ''

            // Populate active loans
            if (active_loans.length > 0) {
              active_loans.forEach((loan) => {
                const loanItem = document.createElement('div')
                loanItem.className = 'list-group-item'
                loanItem.textContent = `Book: ${loan.book.title}, Member: ${loan.customer.username}, Loan Date: ${loan.loan_date}`
                activeLoansContainer.appendChild(loanItem)
              })
            } else {
              activeLoansContainer.innerHTML =
                '<p class="text-muted">No active loans found.</p>'
            }

            // Populate inactive loans
            if (inactive_loans.length > 0) {
              inactive_loans.forEach((loan) => {
                const loanItem = document.createElement('div')
                loanItem.className = 'list-group-item'
                loanItem.textContent = `Book: ${loan.book.title}, Member: ${loan.customer.username}, Loan Date: ${loan.loan_date}, Return Date: ${loan.return_date}`
                inactiveLoansContainer.appendChild(loanItem)
              })
            } else {
              inactiveLoansContainer.innerHTML =
                '<p class="text-muted">No inactive loans found.</p>'
            }
          }
        } catch (error) {
          // Show error message if unauthorized
          if (error.response && error.response.status === 401) {
            document.getElementById('loan-container').style.display = 'none'
            document.getElementById('not-authorized').style.display = 'block'
          } else {
            console.error('An error occurred:', error)
          }
        }
      })
    </script>
  </body>
</html>
