<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loan Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">Loan Management</h1>

      <div id="loan-container">
        <div class="mb-4">
          <h3>Active Loans</h3>
          <div id="active-loans" class="list-group"></div>
        </div>

        <div>
          <h3>Inactive Loans</h3>
          <div id="inactive-loans" class="list-group"></div>
        </div>
      </div>

      <!-- Not Authorized Message -->
      <div
        id="not-authorized"
        class="alert alert-danger text-center mt-5"
        style="display: none"
      >
        <p>You are not authorized to view this page.</p>
        <button onclick="redirectToLogin()" class="btn btn-primary mt-2">
          Go to Login
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // Function to redirect to login page
      function redirectToLogin() {
        window.location.href = '/login.html' // Adjust this URL to match your login page route
      }

      document.addEventListener('DOMContentLoaded', async () => {
        try {
          const response = await axios.get(
            'http://127.0.0.1:8000/loans/display_loans',
            {
              headers: {
                Authorization: 'Bearer ' + localStorage.getItem('token'), // Use token for admin authentication
              },
            }
          )

          if (response.status === 200) {
            const { active_loans, inactive_loans } = response.data

            const activeLoansContainer = document.getElementById('active-loans')
            const inactiveLoansContainer =
              document.getElementById('inactive-loans')

            // Clear existing content
            activeLoansContainer.innerHTML = ''
            inactiveLoansContainer.innerHTML = ''

            // Populate active loans
            if (active_loans.length > 0) {
              active_loans.forEach((loan) => {
                const loanItem = document.createElement('div')
                loanItem.className = 'list-group-item'
                loanItem.textContent = `Book: ${loan.book.title}, Member: ${loan.customer.username}, Loan Date: ${loan.loan_date}`
                activeLoansContainer.appendChild(loanItem)
              })
            } else {
              activeLoansContainer.innerHTML =
                '<p class="text-muted">No active loans found.</p>'
            }

            // Populate inactive loans
            if (inactive_loans.length > 0) {
              inactive_loans.forEach((loan) => {
                const loanItem = document.createElement('div')
                loanItem.className = 'list-group-item'
                loanItem.textContent = `Book: ${loan.book.title}, Member: ${loan.customer.username}, Loan Date: ${loan.loan_date}, Return Date: ${loan.return_date}`
                inactiveLoansContainer.appendChild(loanItem)
              })
            } else {
              inactiveLoansContainer.innerHTML =
                '<p class="text-muted">No inactive loans found.</p>'
            }
          }
        } catch (error) {
          // Show error message if unauthorized
          if (error.response && error.response.status === 401) {
            document.getElementById('loan-container').style.display = 'none'
            document.getElementById('not-authorized').style.display = 'block'
          } else {
            console.error('An error occurred:', error)
          }
        }
      })
    </script>
  </body>
</html>
