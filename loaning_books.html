<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan and Return Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-5">
    <h2 id="welcomeMessage" class="text-center"></h2>
    
    <div class="container mt-5">
        <h2 class="mb-4">Loan a Book</h2>
        <form id="loanForm" class="mb-4">
            <div class="mb-3">
                <label for="bookTitle" class="form-label">Book Title</label>
                <select class="form-select" id="bookTitle" required>
                    <option selected disabled>Choose a book</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Loan Book</button>
        </form>

        <h2 class="mb-4">Return a Book</h2>
        <form id="returnForm" class="mb-4">
            <div class="mb-3">
                <label for="loanedBookTitle" class="form-label">Loaned Book Title</label>
                <select class="form-select" id="loanedBookTitle" required>
                    <option selected disabled>Choose a loaned book</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Return Book</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

    <script>
        const api = axios.create({
            baseURL: 'http://127.0.0.1:8000',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });

        const token = localStorage.getItem('token');
        const decoded = jwt_decode(token);
        const customerId = decoded.user_id;
        // Fetch logged-in user's information and update the title
        async function fetchUserAndOptions() {
            try {
                // Fetch customer details
                const userResponse = await api.get(`/customers/customer/${customerId}/`); // Fetch customer by ID
                const username = userResponse.data.username;
                console.log("*",username)
                // Set welcome message and document title with customer name
                document.getElementById('welcomeMessage').textContent = `Welcome, ${username}`;
                        document.title = `Loan and Return Books - ${username}`;

                
                // Fetch books and loans specific to the logged-in user
                await fetchOptions();
            } catch (error) {
                console.error('Error fetching user information or options:', error);
            }
        }

        async function fetchOptions() {
            try {
                const [booksResponse, loansResponse] = await Promise.all([
                    api.get('/loans/display_books'),
                    api.get(`/loans/customer/${customerId}`)
                ]);
                console.log("***",booksResponse.data)
                populateBookOptions(booksResponse.data);
                populateLoanedBooksOptions(loansResponse.data.active_loans);
            } catch (error) {
                console.error('Error fetching options:', error);
            }
        }

        function populateBookOptions(books) {
            const bookSelect = document.getElementById('bookTitle');
            books.forEach(book => {
                if (book.isActive) {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = book.title;
                    bookSelect.appendChild(option);
                }
            });
        }

        function populateLoanedBooksOptions(activeLoans) {
            const loanedBookSelect = document.getElementById('loanedBookTitle');
            activeLoans.forEach(loan => {
                const option = document.createElement('option');
                option.value = loan.id;
                option.textContent = `${loan.book.title}`;
                loanedBookSelect.appendChild(option);
            });
        }

        async function loanBook(event) {
            event.preventDefault();
            const bookId = document.getElementById('bookTitle').value;

            try {
                await api.post('/loans/loan_book', {  book_id: bookId , customer_id:customerId});
                alert('Book loaned successfully!');
                document.getElementById('loanForm').reset();
                window.location.reload();
            } catch (error) {
                console.error('Error loaning book:', error);
            }
        }

        async function returnBook(event) {
            event.preventDefault();
            const loanedBookId = document.getElementById('loanedBookTitle').value;

            try {
                await api.post('/loans/return_book', { loan_id: loanedBookId });
                alert('Book returned successfully!');
                document.getElementById('returnForm').reset();
                fetchOptions();
            } catch (error) {
                console.error('Error returning book:', error);
            }
        }

        document.getElementById('loanForm').addEventListener('submit', loanBook);
        document.getElementById('returnForm').addEventListener('submit', returnBook);

        // Fetch user info and options on page load
        fetchUserAndOptions();

    </script>
</body>
</html>
