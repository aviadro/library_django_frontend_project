<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan and Return Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Loan a Book</h2>
        <form id="loanForm" class="mb-4">
            <div class="mb-3">
                <label for="bookTitle" class="form-label">Book Title</label>
                <select class="form-select" id="bookTitle" required>
                    <option selected disabled>Choose a book</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="customerName" class="form-label">Customer Name</label>
                <select class="form-select" id="customerName" required>
                    <option selected disabled>Choose a customer</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Loan Book</button>
        </form>

        <h2 class="mb-4">Return a Book</h2>
        <form id="returnForm" class="mb-4">
            <div class="mb-3">
                <label for="loanedBookTitle" class="form-label">Loaned Book Title</label>
                <select class="form-select" id="loanedBookTitle" required>
                    <option selected disabled>Choose a loaned book</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Return Book</button>
        </form>
    </div>

    <script>
        async function fetchOptions() {
            try {
                // Fetch books, customers, and loans
                const [booksResponse, customersResponse, loansResponse] = await Promise.all([
                    axios.get('http://127.0.0.1:8000/loans/display_books', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } }),
                    axios.get('http://127.0.0.1:8000/customers/display_customers', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } }),
                    axios.get('http://127.0.0.1:8000/loans/display_active_loans', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } })
                ]);

                const books = booksResponse.data;
                const customers = customersResponse.data;
                const loanedBooks = loansResponse.data;

                // Populate book titles
                const bookSelect = document.getElementById('bookTitle');
                books.forEach(book => {
                    if (book.isActive) {  // Only show available books
                        const option = document.createElement('option');
                        option.value = book.title;
                        option.textContent = book.title;
                        bookSelect.appendChild(option);
                    }
                });

                // Populate customer names
                const customerSelect = document.getElementById('customerName');
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.username;
                    option.textContent = customer.username;
                    customerSelect.appendChild(option);
                });

                // Populate loaned books for return (only active loans)
                const loanedBookSelect = document.getElementById('loanedBookTitle');
                loanedBooks.forEach(loan => {
                    console.log(loan)
                    const option = document.createElement('option');
                    option.value = loan.id;
                    option.textContent = `${loan.book.title} - ${loan.customer.username}`;
                    loanedBookSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching options:', error);
            }
        }

        async function loanBook(event) {
            event.preventDefault();
            const bookTitle = document.getElementById('bookTitle').value;
            const customerName = document.getElementById('customerName').value;

            try {
                const response = await axios.post('http://127.0.0.1:8000/loans/loan_book', {
                    book_title: bookTitle,
                    customer_name: customerName
                }, {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                alert('Book loaned successfully!');
            } catch (error) {
                console.error('Error loaning book:', error);
            }
        }

        async function returnBook(event) {
            event.preventDefault();
            const loanedBookId = document.getElementById('loanedBookTitle').value;

            try {
                const response = await axios.post('http://127.0.0.1:8000/loans/return_book', {
                    loan_id: loanedBookId
                }, {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                alert('Book returned successfully!');
            } catch (error) {
                console.error('Error returning book:', error);
            }
        }

        document.getElementById('loanForm').addEventListener('submit', loanBook);
        document.getElementById('returnForm').addEventListener('submit', returnBook);

        // Fetch options on page load
        fetchOptions();
    </script>
</body>
</html>
