<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Book Details</h1>

        <!-- Back to All Books button -->
        <div class="text-center mb-4">
            <button onclick="window.location.href = '/all_books.html'" class="btn btn-secondary">Back to All Books</button>
        </div>

        <!-- Book details container -->
        <div id="book-details" class="card" style="display: none;">
            <img id="book-image" class="card-img-top" src="" alt="Book Image" style="max-height: 300px; object-fit: contain;">
            <div class="card-body">
                <h3 id="book-title" class="card-title"></h3>
                <p id="book-author" class="card-text"></p>
                <p id="book-year" class="card-text"></p>
                <p id="book-type" class="card-text"></p>
                <p id="book-description" class="card-text"></p>
                <p id="book-status" class="card-text"></p>
            </div>
        </div>

        <!-- Error message for not found or unauthorized -->
        <div id="error-message" class="alert alert-danger mt-4 text-center" style="display: none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Function to retrieve book ID from the URL
        function getBookIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function fetchBookDetails() {
            const bookId = getBookIdFromUrl();  // Get the book ID from the URL
            if (!bookId) {
                document.getElementById('error-message').textContent = "No book ID provided.";
                document.getElementById('error-message').style.display = 'block';
                return;
            }

            const bookDetailsContainer = document.getElementById('book-details');
            const errorMessageContainer = document.getElementById('error-message');

            // Reset content visibility
            bookDetailsContainer.style.display = 'none';
            errorMessageContainer.style.display = 'none';

            try {
                const response = await axios.get(`http://127.0.0.1:8000/loans/display_book/${bookId}/`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                if (response.status === 200) {
                    const book = response.data;

                    // Populate book details
                    document.getElementById('book-image').src = `http://127.0.0.1:8000/${book.image || 'placeholder.png'}`;
                    document.getElementById('book-title').textContent = book.title;
                    document.getElementById('book-author').textContent = `Author: ${book.author}`;
                    document.getElementById('book-year').textContent = `Published Year: ${book.published_year}`;
                    document.getElementById('book-type').textContent = `Book Type: ${book.book_type}`;
                    document.getElementById('book-description').textContent = `Description: ${book.description || "No description available."}`;
                    document.getElementById('book-status').textContent = `Status: ${book.isActive ? 'Active' : 'Inactive'}`;

                    // Show book details card
                    bookDetailsContainer.style.display = 'block';
                }
            } catch (error) {
                if (error.response && error.response.status === 404) {
                    errorMessageContainer.textContent = "Book not found.";
                } else if (error.response && error.response.status === 403) {
                    errorMessageContainer.textContent = "You are not authorized to view this book.";
                } else {
                    errorMessageContainer.textContent = "An error occurred while retrieving the book details.";
                }
                errorMessageContainer.style.display = 'block';
            }
        }

        // Fetch book details on page load
        fetchBookDetails();
    </script>
</body>
</html>
