<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4 text-center">User List</h2>

        <!-- Search bar for searching by name -->
        <div class="mb-4 text-center">
            <input type="text" id="searchInput" class="form-control mb-2" placeholder="Search by Name" style="width: 300px; margin: 0 auto;">
            <button onclick="searchUsers()" class="btn btn-primary">Search</button>
        </div>
        
        <!-- Table to display users -->
        <table class="table table-striped" id="userTable">
            <thead class="table-dark">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Username</th>
                    <th scope="col">Email</th>
                    <th scope="col">City</th>
                    <th scope="col">Age</th>
                    <th scope="col">Phone</th>
                    <th scope="col">Status</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- User rows will be populated here -->
            </tbody>
        </table>

        <!-- Response message for error handling -->
        <div id="responseMessage" class="mt-3 text-center"></div>
    </div>

    <script>
        // Configure Axios instance
        const api = axios.create({
            baseURL: 'http://127.0.0.1:8000',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });

        // Function to fetch all users
        async function fetchUsers() {
            const userTableBody = document.getElementById('userTableBody');
            const responseMessage = document.getElementById('responseMessage');

            // Clear any previous content
            userTableBody.innerHTML = '';
            responseMessage.innerHTML = '';

            try {
                const response = await api.get('http://127.0.0.1:8000/customers/display_customers');  // Update with your endpoint for listing users
                const users = response.data;

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${user.city || 'N/A'}</td>
                        <td>${user.age || 'N/A'}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>${user.is_active ? 'Active' : 'Inactive'}</td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                let errorMessage = 'An error occurred while fetching the user list.';
                if (error.response && error.response.status === 403) {
                    errorMessage = 'You are not authorized to view this user list.';
                }
                responseMessage.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
            }
        }

        // Function to search users by name
        async function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const userTableBody = document.getElementById('userTableBody');
            const responseMessage = document.getElementById('responseMessage');

            // Clear any previous content
            userTableBody.innerHTML = '';
            responseMessage.innerHTML = '';

            if (!searchTerm) {
                // If no search term is entered, fetch all users
                fetchUsers();
                return;
            }

            try {
                // Make a GET request to search users by name
                const response = await api.get(`http://127.0.0.1:8000/customers/find_customer/${searchTerm}/`);
                const users = response.data;

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${user.city || 'N/A'}</td>
                        <td>${user.age || 'N/A'}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>${user.is_active ? 'Active' : 'Inactive'}</td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                let errorMessage = 'No users found with that name.';
                if (error.response && error.response.status === 403) {
                    errorMessage = 'You are not authorized to search users.';
                }
                responseMessage.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
            }
        }

        // Call the function to fetch users on page load
        fetchUsers();
    </script>
</body>
</html>
